name: Build Xclipse Wrapper for Android 16

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-android-16:
    runs-on: ubuntu-24.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Android SDK and NDK
      uses: android-actions/setup-android@v3
      with:
        ndk-version: '25.2.9519653'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build clang wget

    - name: Install Vulkan SDK
      run: |
        # Download and install Vulkan SDK for Linux
        wget https://sdk.lunarg.com/sdk/download/1.3.268.1/linux/vulkansdk-linux-x86_64-1.3.268.1.tar.gz
        tar -xf vulkansdk-linux-x86_64-1.3.268.1.tar.gz
        echo "VULKAN_SDK=$PWD/1.3.268.1/x86_64" >> $GITHUB_ENV
        echo "$PWD/1.3.268.1/x86_64/bin" >> $GITHUB_PATH

    - name: Check source files for Vulkan issues
      run: |
        echo "Checking source files for Vulkan layer definitions..."
        if [ -f "src/xclipse_wrapper.cpp" ]; then
          grep -n "LAYER_NEGOTIATE_INTERFACE_STRUCT" src/xclipse_wrapper.cpp || echo "Symbol not found in source"
          grep -n "vkNegotiateLoaderLayerInterfaceVersion" src/xclipse_wrapper.cpp || echo "Function not found in source"
        fi

    - name: Configure CMake for Android 16
      run: |
        cmake -B build \
          -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_LATEST_HOME/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=arm64-v8a \
          -DANDROID_PLATFORM=android-34 \
          -DANDROID_STL=c++_shared \
          -DCMAKE_BUILD_TYPE=Release \
          -DVULKAN_HEADERS_INCLUDE_DIR=$VULKAN_SDK/include \
          -G Ninja

    - name: Build
      run: cmake --build build --config Release -j4

    - name: Verify build artifacts
      run: |
        if [ -f "build/libxclipse_wrapper.so" ]; then
          file build/libxclipse_wrapper.so
          readelf -h build/libxclipse_wrapper.so | grep -i machine
        else
          echo "Build artifact not found!"
          find build -name "*.so" -type f
          exit 1
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: xclipse-wrapper-android16
        path: |
          build/libxclipse_wrapper.so
          winlator_xclipse.json
        retention-days: 90
